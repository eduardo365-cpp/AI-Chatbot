<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 聊天助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }

        /* 自訂 Tailwind 配置 */
        @layer utilities {
            .glow-blue {
                text-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.3);
            }
            
            .glow-purple {
                text-shadow: 0 0 20px rgba(168, 85, 247, 0.5), 0 0 40px rgba(168, 85, 247, 0.3);
            }

            .glass {
                background: rgba(30, 41, 59, 0.4);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }

            .glass-light {
                background: rgba(51, 65, 85, 0.3);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }

            /* 自訂滾動條 */
            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }

            .custom-scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(100, 116, 139, 0.3);
                border-radius: 10px;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: rgba(100, 116, 139, 0.5);
            }

            /* 動畫 */
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes pulse-glow {
                0%, 100% {
                    box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
                }
                50% {
                    box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
                }
            }

            @keyframes float {
                0%, 100% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-5px);
                }
            }

            .fade-in-up {
                animation: fadeInUp 0.5s ease-out;
            }

            .pulse-glow {
                animation: pulse-glow 2s infinite;
            }

            .float {
                animation: float 3s ease-in-out infinite;
            }

            /* 訊息氣泡樣式 */
            .message-enter {
                animation: fadeInUp 0.4s ease-out;
            }

            /* Gradient borders */
            .gradient-border {
                position: relative;
            }

            .gradient-border::before {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: 12px;
                padding: 1px;
                background: linear-gradient(135deg, #3b82f6, #a855f7);
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .gradient-border:hover::before {
                opacity: 1;
            }

            /* 修正訊息寬度 */
            .message-bubble {
                max-width: 65%;
                display: inline-block;
            }
        }

        /* 背景粒子效果 */
        .bg-particles {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(168, 85, 247, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.03) 0%, transparent 50%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-gray-100 h-screen overflow-hidden">
    <!-- 背景效果 -->
    <div class="fixed inset-0 bg-particles pointer-events-none"></div>
    
    <div class="relative flex h-screen">
        <!-- 左側邊欄 -->
        <aside class="w-80 glass border-r border-slate-700/50 flex flex-col relative z-10">
            <!-- 頂部固定區 -->
            <div class="p-4 border-b border-slate-700/50 space-y-3">
                <!-- Logo 標題 -->
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center float">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold glow-blue">AI 聊天助手</h2>
                </div>

                <!-- 搜尋框 -->
                <div class="relative">
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="搜尋對話..." 
                        class="w-full px-4 py-2.5 pl-10 bg-slate-800/50 border border-slate-700/50 rounded-xl text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition-all"
                    >
                    <svg class="w-4 h-4 absolute left-3 top-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>

                <!-- 新對話按鈕 -->
                <button 
                    onclick="createNewConversation()" 
                    class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-medium text-sm shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transition-all duration-300 hover:scale-105 flex items-center justify-center gap-2 pulse-glow"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    新對話
                </button>
            </div>

            <!-- 對話列表 -->
            <div id="conversationList" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2">
                <!-- 動態載入 -->
            </div>
        </aside>

        <!-- 主要聊天區 -->
        <main class="flex-1 flex flex-col relative">
            <!-- 頂部標題列 -->
            <header class="glass-light border-b border-slate-700/50 px-8 py-5 flex items-center gap-3">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-lg shadow-purple-500/30">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        智能對話
                    </h1>
                    <p class="text-xs text-gray-400 mt-0.5">由 OpenAI GPT-4 驅動</p>
                </div>
            </header>

            <!-- 訊息顯示區 -->
            <div id="chatMessages" class="flex-1 overflow-y-auto custom-scrollbar px-8 py-6 space-y-6">
                <!-- 空狀態 -->
                <div class="flex flex-col items-center justify-center h-full text-center fade-in-up">
                    <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-blue-500/20 to-purple-600/20 flex items-center justify-center mb-6 float">
                        <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-300 mb-2">開始新對話</h3>
                    <p class="text-sm text-gray-500 max-w-md">點擊左上角「新對話」按鈕，或直接在下方輸入訊息開始與 AI 對話</p>
                </div>
            </div>

            <!-- 輸入區域 -->
            <div class="glass-light border-t border-slate-700/50 px-8 py-6">
                <div class="max-w-4xl mx-auto">
                    <div class="relative flex items-end gap-3">
                        <!-- 輸入框 -->
                        <div class="flex-1 relative">
                            <textarea 
                                id="messageInput"
                                placeholder="輸入訊息... (Enter 送出，Shift+Enter 換行)"
                                rows="1"
                                class="w-full px-5 py-4 pr-12 bg-slate-800/50 border border-slate-700/50 rounded-2xl text-gray-200 placeholder-gray-500 resize-none focus:outline-none focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition-all custom-scrollbar"
                                style="max-height: 200px;"
                            ></textarea>
                            
                            <!-- 字數提示 -->
                            <div class="absolute bottom-3 right-3 text-xs text-gray-600" id="charCount">0</div>
                        </div>

                        <!-- 送出按鈕 -->
                        <button 
                            id="sendBtn"
                            onclick="sendMessage()" 
                            class="px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-2xl font-medium shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transition-all duration-300 hover:scale-105 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                            送出
                        </button>
                    </div>
                    
                    <!-- 提示文字 -->
                    <p class="text-xs text-gray-600 mt-3 text-center">
                        AI 可能會產生不準確的訊息，請謹慎使用
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentConversationId = null;
        let allConversations = [];
        let isSending = false; // ✅ 防止重複送出

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConversations();
            setupInputHandlers();
            setupSearch();
        });

        // 載入對話列表
        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations');
                allConversations = await response.json();
                renderConversations(allConversations);
            } catch (error) {
                console.error('載入對話列表失敗:', error);
            }
        }

        // 渲染對話列表
        function renderConversations(conversations) {
            const listEl = document.getElementById('conversationList');
            listEl.innerHTML = '';
            
            if (conversations.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-8">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        尚無對話記錄
                    </div>
                `;
                return;
            }
            
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = `relative group cursor-pointer transition-all duration-300 ${
                    conv.id === currentConversationId 
                        ? 'bg-gradient-to-r from-blue-600/20 to-purple-600/20 border-blue-500/50' 
                        : 'bg-slate-800/30 hover:bg-slate-800/50 border-slate-700/30'
                } border rounded-xl p-4 hover:scale-[1.02] hover:shadow-lg hover:shadow-blue-500/10`;
                
                const time = new Date(conv.updated_at).toLocaleString('zh-TW', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                item.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500/30 to-purple-600/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm text-gray-200 truncate mb-1">${conv.title || '新對話'}</h3>
                            <p class="text-xs text-gray-500">${time}</p>
                        </div>
                    </div>
                    <button 
                        onclick="deleteConversation(${conv.id}, event)" 
                        class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity bg-red-500/80 hover:bg-red-500 rounded-lg p-1.5"
                    >
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                `;
                
                item.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        loadConversation(conv.id);
                    }
                };
                
                listEl.appendChild(item);
            });
        }

        // 搜尋功能
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if (query === '') {
                    renderConversations(allConversations);
                } else {
                    const filtered = allConversations.filter(conv => 
                        (conv.title || '').toLowerCase().includes(query)
                    );
                    renderConversations(filtered);
                }
            });
        }

        // 載入特定對話
        async function loadConversation(convId) {
            try {
                currentConversationId = convId;
                
                const response = await fetch(`/api/conversation/${convId}`);
                const messages = await response.json();
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                messages.forEach(msg => {
                    appendMessage(msg.role, msg.content, msg.timestamp, false);
                });
                
                scrollToBottom();
                renderConversations(allConversations);
                
            } catch (error) {
                console.error('載入對話失敗:', error);
            }
        }

        // 建立新對話
        async function createNewConversation() {
            try {
                const response = await fetch('/api/conversation', {
                    method: 'POST'
                });
                const data = await response.json();
                
                currentConversationId = data.conversation_id;
                document.getElementById('chatMessages').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center fade-in-up">
                        <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-blue-500/20 to-purple-600/20 flex items-center justify-center mb-6 float">
                            <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-300 mb-2">新對話已建立</h3>
                        <p class="text-sm text-gray-500">開始輸入你的第一個訊息</p>
                    </div>
                `;
                document.getElementById('messageInput').focus();
                loadConversations();
                
            } catch (error) {
                console.error('建立對話失敗:', error);
                showNotification('建立對話失敗，請稍後再試', 'error');
            }
        }

        // 刪除對話
        async function deleteConversation(convId, event) {
            event.stopPropagation();
            
            if (!confirm('確定要刪除此對話嗎？')) {
                return;
            }
            
            try {
                await fetch(`/api/conversation/${convId}`, {
                    method: 'DELETE'
                });
                
                if (currentConversationId === convId) {
                    currentConversationId = null;
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center fade-in-up">
                            <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-blue-500/20 to-purple-600/20 flex items-center justify-center mb-6 float">
                                <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-300 mb-2">開始新對話</h3>
                            <p class="text-sm text-gray-500">點擊左上角「新對話」按鈕開始</p>
                        </div>
                    `;
                }
                
                loadConversations();
                showNotification('對話已刪除', 'success');
                
            } catch (error) {
                console.error('刪除對話失敗:', error);
                showNotification('刪除失敗，請稍後再試', 'error');
            }
        }

        // ✅ 發送訊息 - 加入防抖機制
        async function sendMessage() {
            // 防止重複送出
            if (isSending) {
                console.log('正在處理中，請稍候...');
                return;
            }

            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 設定發送狀態
            isSending = true;
            sendBtn.disabled = true;
            input.disabled = true;
            
            if (!currentConversationId) {
                await createNewConversation();
            }
            
            appendMessage('user', message, new Date().toISOString(), true);
            input.value = '';
            input.style.height = 'auto';
            updateCharCount();
            
            showLoading();
            
            try {
                const response = await fetch(`/api/conversation/${currentConversationId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                removeLoading();
                appendMessage('assistant', data.ai_response, data.timestamp, true);
                loadConversations();
                
            } catch (error) {
                console.error('發送訊息失敗:', error);
                removeLoading();
                showNotification('發送失敗，請稍後再試', 'error');
            } finally {
                // 恢復狀態
                isSending = false;
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // ✅ 附加訊息 - 修正寬度問題
        function appendMessage(role, content, timestamp, shouldScroll) {
            const chatMessages = document.getElementById('chatMessages');
            
            const emptyState = chatMessages.querySelector('.fade-in-up');
            if (emptyState && emptyState.textContent.includes('開始')) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-4 message-enter ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            const time = new Date(timestamp).toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const avatarGradient = role === 'user' 
                ? 'from-blue-500 to-cyan-500' 
                : 'from-purple-500 to-pink-600';
            
            const bubbleBg = role === 'user'
                ? 'bg-gradient-to-r from-blue-600/20 to-cyan-600/20 border-blue-500/30'
                : 'bg-slate-800/50 border-slate-700/50';
            
            messageDiv.innerHTML = `
                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br ${avatarGradient} flex items-center justify-center shadow-lg flex-shrink-0">
                    ${role === 'user' 
                        ? '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>'
                        : '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>'
                    }
                </div>
                <div class="message-bubble">
                    <div class="px-5 py-3.5 rounded-2xl border ${bubbleBg} shadow-lg">
                        <p class="text-gray-200 leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</p>
                    </div>
                    <p class="text-xs text-gray-600 mt-2 ${role === 'user' ? 'text-right' : ''}">${time}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            if (shouldScroll) {
                scrollToBottom();
            }
        }

        // Loading 動畫
        function showLoading() {
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.className = 'flex gap-4 message-enter';
            loadingDiv.innerHTML = `
                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-lg">
                    <svg class="w-5 h-5 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div>
                    <div class="px-5 py-3.5 rounded-2xl bg-slate-800/50 border border-slate-700/50 shadow-lg inline-block">
                        <div class="flex gap-1.5">
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            scrollToBottom();
        }

        function removeLoading() {
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }

        // 滾動到底部
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // ✅ 設定輸入處理 - 改進 Enter 處理
        function setupInputHandlers() {
            const input = document.getElementById('messageInput');
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!isSending) {  // 只在未處理時才送出
                        sendMessage();
                    }
                }
            });
            
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                updateCharCount();
            });
        }

        // 更新字數
        function updateCharCount() {
            const input = document.getElementById('messageInput');
            const count = input.value.length;
            document.getElementById('charCount').textContent = count;
        }

        // 通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 fade-in-up ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                notification.style.transition = 'all 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // HTML 轉義
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
